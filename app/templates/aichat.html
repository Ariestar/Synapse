{% extends "base.html" %}

{% block title %}ChatBox - KingStudy{% endblock %}
{% block page_title %}ChatBox{% endblock %}

{% block x_data %}chatApp(){% endblock %}

{% block head %}
<style type="text/tailwindcss">
    @layer components {
        .message-container {
            @apply flex gap-4 mb-6 max-w-[95%] lg:max-w-[85%];
        }
        .message-container.user {
            @apply ml-auto flex-row-reverse;
        }
        .message-container.bot {
            @apply mr-auto;
        }

        .avatar {
            @apply w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold shrink-0;
        }
        .user-avatar {
            @apply bg-black text-white;
        }
        .bot-avatar {
            @apply bg-white border border-gray-200 text-black;
        }
        .reasoner-avatar {
            @apply bg-gray-100 text-gray-600;
        }

        .message {
            @apply px-4 py-3 rounded-2xl text-sm leading-relaxed shadow-sm max-w-full overflow-hidden;
        }
        .user-message {
            @apply bg-black text-white rounded-tr-sm;
        }
        .bot-message {
            @apply bg-white border border-gray-200 text-gray-900 rounded-tl-sm;
        }
        .reasoner-message {
            @apply bg-gray-50 border border-gray-100 text-gray-600 italic rounded-tl-sm;
        }

        .message-time {
            @apply text-[10px] mt-1 opacity-50;
        }
        .user .message-time {
            @apply text-right text-gray-400;
        }
        .bot .message-time {
            @apply text-left text-gray-400;
        }

        /* Chat Notes Card */
        .chat-note-card {
            @apply bg-white border border-gray-200 rounded-lg p-3 mb-2 cursor-pointer hover:border-black transition-colors;
        }
        .chat-note-card-header {
            @apply flex justify-between items-start gap-2 mb-1;
        }
        .chat-note-card-title {
            @apply font-medium text-sm text-black line-clamp-1;
        }
        .chat-note-card-score {
            @apply text-[10px] bg-gray-100 px-1.5 py-0.5 rounded-full text-gray-600;
        }
        .chat-note-card-path {
            @apply text-[10px] text-gray-400 mb-2 truncate;
        }
        .chat-note-card-body {
            @apply text-xs text-gray-600 line-clamp-2 mb-2;
        }
        .chat-note-card-tags {
            @apply flex flex-wrap gap-1;
        }
        .chat-note-card-tag {
            @apply text-[10px] bg-gray-50 text-gray-500 px-1.5 py-0.5 rounded border border-gray-100;
        }
        
        .typing-dot {
            @apply w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.1s; }
        .typing-dot:nth-child(3) { animation-delay: 0.2s; }
    }
</style>
{% endblock %}

{% block content %}
<div class="flex flex-col h-full relative" x-init="init()">
    <!-- Chat Area -->
    <div class="flex-1 overflow-y-auto p-4 lg:p-8 !pb-72 scrollbar-hide" id="chat-messages">
        <!-- Messages injected by scripts.js -->
        <div class="message-container bot">
            <div class="avatar bot-avatar">AI</div>
            <div class="message-content">
                <div class="message bot-message">
                    ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ AI åŠ©æ‰‹ã€‚æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®ä½ çš„å—ï¼Ÿ
                </div>
                <div class="message-time">åˆšåˆš</div>
            </div>
        </div>
    </div>
    
    <!-- Typing Indicator -->
    <div id="typing-indicator" class="hidden absolute bottom-28 left-8 bg-white border border-gray-200 rounded-full px-4 py-2 shadow-sm items-center gap-1 z-10">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
    </div>

    <!-- Input Area -->
    <div class="absolute bottom-0 left-0 right-0 bg-white/90 backdrop-blur border-t border-gray-200 p-4 lg:px-8 lg:py-6 z-20">
        <div class="max-w-4xl mx-auto relative">
             <!-- Toolbar -->
             <div class="absolute -top-10 left-0 flex gap-2 overflow-x-auto max-w-full pb-2 scrollbar-hide">
                 <template x-for="tool in availableTools" :key="tool.id">
                     <button 
                        class="flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium transition-colors border shadow-sm shrink-0"
                        :class="settings.enabledTools.includes(tool.id) ? 'bg-black text-white border-transparent' : 'bg-white text-gray-600 border-gray-200 hover:border-gray-300'"
                        @click="toggleTool(tool.id)"
                        :title="tool.desc"
                     >
                        <span x-text="tool.icon"></span>
                        <span x-text="tool.name"></span>
                     </button>
                 </template>
             </div>
             
             <!-- Input Box -->
             <div class="relative flex items-end gap-2 bg-gray-50 border border-gray-200 rounded-2xl p-2 focus-within:ring-1 focus-within:ring-black focus-within:border-black transition-all shadow-sm hover:border-gray-300">
                 <textarea 
                    id="message-input" 
                    placeholder="è¾“å…¥æ¶ˆæ¯..." 
                    rows="1"
                    @keydown.enter.exact.prevent="sendMessage()"
                    @input="autoResize($el)"
                    class="w-full bg-transparent border-none focus:ring-0 resize-none max-h-32 min-h-[44px] py-2.5 px-3 text-sm text-gray-900 placeholder-gray-400"
                 ></textarea>
                 
                 <div class="flex gap-1 pb-1">
                     <button 
                        id="save-note-button" 
                        title="ä¿å­˜ä¸ºç¬”è®°"
                        @click="saveConversationAsNote()"
                        class="p-2 text-gray-400 hover:text-black hover:bg-gray-100 rounded-xl transition-colors"
                     >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                     </button>
                     <button 
                        id="send-button" 
                        title="å‘é€"
                        @click="sendMessage()"
                        class="p-2 bg-black text-white rounded-xl hover:opacity-80 transition-opacity disabled:opacity-50 flex items-center justify-center w-9 h-9"
                     >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"></path></svg>
                     </button>
                 </div>
             </div>
             <div class="text-center mt-2 text-[10px] text-gray-400">AI å¯èƒ½ä¼šäº§ç”Ÿé”™è¯¯ï¼Œè¯·æ ¸å¯¹é‡è¦ä¿¡æ¯ã€‚</div>
        </div>
    </div>
</div>
{% endblock %}

{% block modals %}
    <!-- Settings Modal -->
    <div 
        class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm"
        x-show="settingsOpen"
        x-cloak
        @click.self="settingsOpen = false"
    >
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 overflow-hidden border border-gray-100">
            <div class="flex justify-between items-center p-4 border-b border-gray-100">
                <h3 class="font-bold text-lg">API è®¾ç½®</h3>
                <button @click="settingsOpen = false" class="text-gray-400 hover:text-black">&times;</button>
            </div>
            <form class="p-6 space-y-4 max-h-[70vh] overflow-y-auto" @submit.prevent="saveSettings()">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æä¾›å•†</label>
                    <select id="provider-select" x-model="settings.provider" @change="loadModels($event.target.value)" class="w-full p-2 border border-gray-200 rounded-lg text-sm focus:border-black focus:ring-0">
                        <option value="bigmodel">æ™ºè°±AI</option>
                        <option value="deepseek">DeepSeek</option>
                        <option value="openai">OpenAI</option>
                        <option value="qwen">é€šä¹‰åƒé—®</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">API åœ°å€</label>
                    <input type="text" id="api-url" x-model="settings.apiUrl" placeholder="é»˜è®¤åœ°å€" class="w-full p-2 border border-gray-200 rounded-lg text-sm focus:border-black focus:ring-0">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                    <input type="password" id="api-key" x-model="settings.apiKey" class="w-full p-2 border border-gray-200 rounded-lg text-sm focus:border-black focus:ring-0">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ¨¡å‹</label>
                    <select id="model-name" x-model="settings.modelName" class="w-full p-2 border border-gray-200 rounded-lg text-sm focus:border-black focus:ring-0">
                        <option value="">è¯·é€‰æ‹©æ¨¡å‹</option>
                        <template x-for="model in models" :key="model.id">
                            <option :value="model.id" x-text="model.name"></option>
                        </template>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">è§’è‰²è®¾å®š</label>
                    <textarea id="persona" x-model="settings.persona" rows="3" class="w-full p-2 border border-gray-200 rounded-lg text-sm focus:border-black focus:ring-0"></textarea>
                </div>
            </form>
            <div class="p-4 border-t border-gray-100 flex justify-end gap-2 bg-gray-50">
                <button @click="clearSettings()" class="px-4 py-2 text-sm text-red-600 hover:bg-red-50 rounded-lg">æ¸…é™¤</button>
                <button @click="saveSettings()" class="px-4 py-2 text-sm text-white bg-black hover:opacity-80 rounded-lg shadow-sm">ä¿å­˜</button>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    function chatApp() {
        return {
            sidebarOpen: false,
            settingsOpen: false,
            settings: {
                provider: 'bigmodel',
                apiUrl: '',
                apiKey: '',
                modelName: '',
                persona: '',
                searchNotes: true,
                enabledTools: ['search_notes', 'brainstorm']
            },
            availableTools: [
                { id: 'search_notes', name: 'æŸ¥è¯¢ç¬”è®°', icon: 'ğŸ“', desc: 'æŸ¥è¯¢æœ¬åœ°ç¬”è®°åº“' },
                { id: 'search_internet', name: 'è”ç½‘', icon: 'ğŸŒ', desc: 'æœç´¢äº’è”ç½‘' },
                { id: 'brainstorm', name: 'æ¦‚å¿µç¢°æ’', icon: 'âš¡', desc: 'å¯»æ‰¾çµæ„Ÿä¸è¿æ¥' }
            ],
            models: [],
            
            init() {
                this.loadSettings();
                this.loadModels(this.settings.provider);
            },
            
            loadSettings() {
                const saved = JSON.parse(localStorage.getItem('llmSettings')) || {};
                
                // è¿ç§»æ—§ç‰ˆ searchNotes é…ç½®
                if (saved.enabledTools === undefined) {
                    saved.enabledTools = ['search_notes', 'brainstorm'];
                    // ä»¥å‰çš„ searchNotes é€»è¾‘å¯èƒ½å·²ç»ä¸å†éœ€è¦ä¸¥æ ¼å…¼å®¹ï¼Œä½†ä¸ºäº†ä¿é™©èµ·è§
                    if (saved.searchNotes === false) {
                        saved.enabledTools = saved.enabledTools.filter(t => t !== 'search_notes');
                    }
                }
                
                this.settings = { ...this.settings, ...saved };
            },
            
            toggleTool(id) {
                if (this.settings.enabledTools.includes(id)) {
                    this.settings.enabledTools = this.settings.enabledTools.filter(t => t !== id);
                } else {
                    this.settings.enabledTools.push(id);
                }
                // åŒæ­¥æ›´æ–° searchNotes ç”¨äºå…¼å®¹
                if (id === 'search_notes') {
                    this.settings.searchNotes = this.settings.enabledTools.includes('search_notes');
                }
                this.saveSettings();
            },
            
            toggleSearchNotes() {
                // Deprecated by toggleTool
                this.toggleTool('search_notes');
            },
            
            async loadModels(provider) {
                if (!provider) provider = 'bigmodel';
                try {
                    const response = await fetch(`/list_models?provider=${provider}`);
                    if (response.ok) {
                        this.models = await response.json();
                    }
                } catch (error) {
                    console.error('Failed to load models:', error);
                    this.models = [];
                }
            },
            
            saveSettings() {
                localStorage.setItem('llmSettings', JSON.stringify(this.settings));
                this.settingsOpen = false;
            },
            
            clearSettings() {
                localStorage.removeItem('llmSettings');
                this.settings = {
                    provider: 'bigmodel',
                    apiUrl: '',
                    apiKey: '',
                    modelName: '',
                    persona: '',
                    searchNotes: true,
                    enabledTools: ['search_notes', 'brainstorm']
                };
            },
            
            createNewChat() {
                if (window.createNewConversation) window.createNewConversation();
            },
            
            sendMessage() {
                if (window.sendMessage) window.sendMessage();
            },
            
            saveConversationAsNote() {
                if (window.saveConversationAsNote) window.saveConversationAsNote();
            },
            
            autoResize(textarea) {
                textarea.style.height = 'auto';
                textarea.style.height = textarea.scrollHeight + 'px';
            }
        };
    }
</script>
<script src="../static/js/scripts.js"></script>
{% endblock %}
