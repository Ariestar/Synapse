{% extends "base.html" %}

{% block title %}Notes - KingStudy{% endblock %}
{% block page_title %}Notes{% endblock %}

{% block content %}
<div x-data="notesPage()" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Controls -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
        <div class="relative flex-1 w-full sm:max-w-md">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>
            <input 
                type="text" 
                id="search-notes" 
                placeholder="ç­›é€‰ç¬”è®°..." 
                class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-black focus:border-black sm:text-sm"
            >
        </div>
        
        <div class="flex gap-2 w-full sm:w-auto">
            <button 
                @click="$dispatch('open-rag-search')" 
                class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-black flex-1 sm:flex-none justify-center"
            >
                <span class="mr-2">ğŸ”</span> æ™ºèƒ½æ£€ç´¢
            </button>
            <div class="flex gap-2 flex-1 sm:flex-none">
                <div class="relative flex items-center" x-data="{ open: false, selected: 'random', labels: { 'random': 'éšæœºç¢°æ’', 'mmr': 'å·®å¼‚æœ€å¤§' } }">
                    <!-- Custom Select Button -->
                    <button 
                        @click="open = !open" 
                        @click.away="open = false"
                        class="relative w-full sm:w-32 py-2 pl-3 pr-8 text-left bg-white border border-gray-300 rounded-md shadow-sm cursor-default focus:outline-none focus:ring-1 focus:ring-black focus:border-black sm:text-sm hover:bg-gray-50 transition-colors"
                    >
                        <span class="block truncate" x-text="labels[selected]"></span>
                        <span class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
                            <svg class="w-4 h-4 text-gray-400" viewBox="0 0 20 20" fill="none" stroke="currentColor">
                                <path d="M7 7l3-3 3 3m0 6l-3 3-3-3" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </span>
                    </button>

                    <!-- Dropdown Menu -->
                    <div 
                        x-show="open" 
                        x-transition:enter="transition ease-out duration-100"
                        x-transition:enter-start="transform opacity-0 scale-95"
                        x-transition:enter-end="transform opacity-100 scale-100"
                        x-transition:leave="transition ease-in duration-75"
                        x-transition:leave-start="transform opacity-100 scale-100"
                        x-transition:leave-end="transform opacity-0 scale-95"
                        class="absolute right-0 z-10 w-full mt-1 bg-white shadow-lg max-h-60 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto focus:outline-none sm:text-sm top-full"
                        style="display: none;"
                        x-cloak
                    >
                        <div 
                            @click="selected = 'random'; open = false; document.getElementById('brainstorm-mode').value = 'random'" 
                            class="cursor-pointer select-none relative py-2 pl-3 pr-9 hover:bg-gray-100 hover:text-black"
                            :class="selected === 'random' ? 'bg-blue-50 text-blue-600' : 'text-gray-900'"
                        >
                            <span class="block truncate font-medium" :class="selected === 'random' ? 'font-semibold' : 'font-normal'">éšæœºç¢°æ’</span>
                            <span x-show="selected === 'random'" class="absolute inset-y-0 right-0 flex items-center pr-4 text-blue-600">
                                <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                                </svg>
                            </span>
                        </div>
                        <div 
                            @click="selected = 'mmr'; open = false; document.getElementById('brainstorm-mode').value = 'mmr'" 
                            class="cursor-pointer select-none relative py-2 pl-3 pr-9 hover:bg-gray-100 hover:text-black"
                            :class="selected === 'mmr' ? 'bg-blue-50 text-blue-600' : 'text-gray-900'"
                        >
                            <span class="block truncate font-medium" :class="selected === 'mmr' ? 'font-semibold' : 'font-normal'">å·®å¼‚æœ€å¤§</span>
                            <span x-show="selected === 'mmr'" class="absolute inset-y-0 right-0 flex items-center pr-4 text-blue-600">
                                <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                                </svg>
                            </span>
                        </div>
                    </div>

                    <!-- Hidden Native Select for compatibility -->
                    <select id="brainstorm-mode" class="hidden">
                        <option value="random">éšæœºç¢°æ’</option>
                        <option value="mmr">å·®å¼‚æœ€å¤§</option>
                    </select>

                    <button 
                        id="brainstorm-btn"
                        class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-black hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-black whitespace-nowrap ml-2"
                    >
                        ğŸ’¡ æ¦‚å¿µç¢°æ’
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Notes Grid -->
    <div id="notes-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Notes will be injected here by JS -->
        <div class="col-span-full text-center py-12">
            <p class="text-gray-500 text-lg">æ­£åœ¨åŠ è½½ç¬”è®°...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block modals %}
    <!-- New Note Modal -->
    <div 
        x-data="newNoteModal()"
        x-show="isOpen"
        @keydown.escape.window="close()"
        @open-new-note.window="open()"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm"
        style="display: none;"
        x-cloak
    >
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4 overflow-hidden border border-gray-100" @click.away="close()">
            <div class="flex justify-between items-center p-4 border-b border-gray-100">
                <h3 class="font-bold text-lg">æ–°å»ºç¬”è®°</h3>
                <button @click="close()" class="text-gray-400 hover:text-black">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ ‡é¢˜</label>
                    <input type="text" x-model="title" @keydown.enter.prevent="saveNote()" x-ref="titleInput" class="w-full p-2 border border-gray-300 rounded-md focus:border-black focus:ring-0">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">å†…å®¹</label>
                    <textarea x-model="content" rows="10" class="w-full p-2 border border-gray-300 rounded-md focus:border-black focus:ring-0 font-mono text-sm"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ ‡ç­¾</label>
                    <input type="text" x-model="tagsInput" placeholder="ä¾‹å¦‚ï¼šå­¦ä¹ , ç¬”è®°" class="w-full p-2 border border-gray-300 rounded-md focus:border-black focus:ring-0">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ç›®å½•</label>
                    <select x-model="subdir" class="w-full p-2 border border-gray-300 rounded-md focus:border-black focus:ring-0">
                        <option value="">æ ¹ç›®å½•</option>
                        <option value="Chat">Chat</option>
                        <option value="å­¦ä¹ ç¬”è®°">å­¦ä¹ ç¬”è®°</option>
                        <option value="æŠ€æœ¯æ–‡æ¡£">æŠ€æœ¯æ–‡æ¡£</option>
                        <option value="éšç¬”">éšç¬”</option>
                    </select>
                </div>
            </div>
            <div class="p-4 border-t border-gray-100 flex justify-end gap-2 bg-gray-50">
                <button @click="close()" class="px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-md">å–æ¶ˆ</button>
                <button @click="saveNote()" :disabled="saving || !title.trim()" class="px-4 py-2 text-sm text-white bg-black hover:opacity-80 rounded-md shadow-sm disabled:opacity-50">
                    <span x-show="!saving">ä¿å­˜</span>
                    <span x-show="saving">ä¿å­˜ä¸­...</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Brainstorm Modal -->
    <div id="brainstorm-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl mx-4 overflow-hidden border border-gray-100 flex flex-col max-h-[85vh]">
            <div class="flex justify-between items-center p-4 border-b border-gray-100">
                <h2 class="font-bold text-lg">æ¦‚å¿µç¢°æ’ç»“æœ</h2>
                <button id="close-brainstorm" class="text-gray-400 hover:text-black text-2xl">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto flex-1">
                <div class="mb-6">
                    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-2">æ¥æºç¬”è®°</h3>
                    <div id="brainstorm-sources" class="bg-gray-50 p-4 rounded-lg text-sm text-gray-700"></div>
                </div>
                <div>
                    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-2">åˆ›æ„ç»“æœ</h3>
                    <div id="brainstorm-body" class="prose prose-sm max-w-none text-gray-800"></div>
                </div>
            </div>
            <div class="p-4 border-t border-gray-100 flex justify-end bg-gray-50">
                <button id="close-brainstorm-footer" class="px-4 py-2 text-sm text-gray-700 hover:bg-gray-200 rounded-md">å…³é—­</button>
            </div>
        </div>
    </div>
    
    <!-- View Note Modal (Legacy Support if needed, though we prefer redirecting to view page) -->
    <div id="view-note-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm hidden">
        <!-- Kept for compatibility if scripts.js uses it, but we prefer navigation -->
    </div>
{% endblock %}

{% block scripts %}
<script>
    // New Note Modal Component
    function newNoteModal() {
        return {
            isOpen: false,
            title: '',
            content: '',
            tagsInput: '',
            subdir: '',
            saving: false,
            
            init() {
                window.addEventListener('open-new-note', () => this.open());
            },
            
            open() {
                this.isOpen = true;
                this.title = '';
                this.content = '';
                this.tagsInput = '';
                this.subdir = '';
                this.saving = false;
                this.$nextTick(() => {
                    if (this.$refs.titleInput) this.$refs.titleInput.focus();
                });
            },
            
            close() {
                this.isOpen = false;
            },
            
            async saveNote() {
                if (!this.title.trim()) return alert('è¯·è¾“å…¥æ ‡é¢˜');
                this.saving = true;
                try {
                    const tags = this.tagsInput.split(/[,ï¼Œ\s]+/).filter(t => t.trim());
                    const response = await fetch('/api/md/file', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            title: this.title.trim(),
                            content: this.content.trim() || `# ${this.title.trim()}\n\n`,
                            tags: tags,
                            subdir: this.subdir || undefined
                        })
                    });
                    if (response.ok) {
                        const res = await response.json();
                        alert(`å·²åˆ›å»ºï¼š${res.path}`);
                        this.close();
                        loadNotes(); // Refresh grid
                    } else {
                        alert('åˆ›å»ºå¤±è´¥');
                    }
                } catch (e) {
                    alert('å‡ºé”™');
                } finally {
                    this.saving = false;
                }
            }
        };
    }

    function notesPage() {
        return {
            // Page logic if any
        };
    }

    // Legacy JS logic adapted
    const API_BASE_URL = '/api';
    const MD_LIST_API = '/api/md/files';
    
    const notesContainer = document.getElementById('notes-container');
    const searchInput = document.getElementById('search-notes');
    let mdFiles = [];

    document.addEventListener('DOMContentLoaded', function() {
        loadNotes();
        searchInput.addEventListener('input', debounce(searchNotes, 300));
        
        // Brainstorm logic
        const brainstormBtn = document.getElementById('brainstorm-btn');
        const brainstormModal = document.getElementById('brainstorm-modal');
        const closeBrainstormBtns = [document.getElementById('close-brainstorm'), document.getElementById('close-brainstorm-footer')];
        
        if (brainstormBtn) {
            brainstormBtn.addEventListener('click', runBrainstorm);
        }
        closeBrainstormBtns.forEach(btn => {
            if (btn) btn.addEventListener('click', () => brainstormModal.classList.add('hidden'));
        });
        
        // Close modal on outside click
        if (brainstormModal) {
            brainstormModal.addEventListener('click', (e) => {
                if (e.target === brainstormModal) brainstormModal.classList.add('hidden');
            });
        }
    });

    async function loadNotes() {
        try {
            const response = await fetch(MD_LIST_API);
            if (response.ok) {
                const data = await response.json();
                mdFiles = data.result || [];
                displayNotes(mdFiles);
            }
        } catch (error) {
            notesContainer.innerHTML = '<div class="col-span-full text-center text-red-500">åŠ è½½å¤±è´¥</div>';
        }
    }

    function displayNotes(notes) {
        if (!notes || notes.length === 0) {
            notesContainer.innerHTML = `
                <div class="col-span-full text-center py-12 bg-gray-50 rounded-xl border border-dashed border-gray-300">
                    <p class="text-gray-500">æš‚æ— ç¬”è®°</p>
                    <button class="mt-4 text-blue-600 hover:text-black font-medium" onclick="window.dispatchEvent(new CustomEvent('open-new-note'))">åˆ›å»ºç¬¬ä¸€ç¯‡ç¬”è®°</button>
                </div>
            `;
            return;
        }
        
        notesContainer.innerHTML = '';
        notes.forEach(note => {
            const normalizedTags = Array.isArray(note.tags) ? note.tags : (typeof note.tags === 'string' ? note.tags.split(/[,ï¼Œ\s]+/).filter(Boolean) : []);
            
            const card = document.createElement('div');
            // Tailwind classes for card
            card.className = 'group bg-white border border-gray-200 rounded-xl p-6 shadow-sm hover:shadow-md hover:border-black transition-all cursor-pointer flex flex-col h-full';
            card.innerHTML = `
                <h3 class="text-lg font-bold text-gray-900 mb-2 line-clamp-1 group-hover:text-blue-600 transition-colors">${note.title || 'æœªå‘½å'}</h3>
                <div class="text-sm text-gray-500 mb-4 line-clamp-4 flex-grow">${note.path || ''}</div>
                <div class="flex flex-wrap gap-2 mt-auto">
                    ${normalizedTags.map(tag => `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">${tag}</span>`).join('')}
                </div>
                <div class="flex justify-between text-xs text-gray-400 mt-4 pt-4 border-t border-gray-50">
                    <span>${note.status || 'Active'}</span>
                    <span class="truncate ml-2">${note.path}</span>
                </div>
            `;
            card.addEventListener('click', () => window.location.href = `/notes_view.html?path=${encodeURIComponent(note.path)}`);
            notesContainer.appendChild(card);
        });
    }

    function searchNotes() {
        const query = searchInput.value.trim().toLowerCase();
        if (!query) {
            displayNotes(mdFiles);
            return;
        }
        const filtered = mdFiles.filter(n => {
            const title = (n.title || '').toLowerCase();
            const tags = (n.tags || []).join(',').toLowerCase();
            const path = (n.path || '').toLowerCase();
            const content = (n.content || '').toLowerCase();
            return title.includes(query) || tags.includes(query) || path.includes(query) || content.includes(query);
        });
        displayNotes(filtered);
    }

    function debounce(func, delay) {
        let timeoutId;
        return function (...args) {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => func.apply(this, args), delay);
        };
    }

    // Brainstorm logic
    async function runBrainstorm() {
        const btn = document.getElementById('brainstorm-btn');
        const mode = document.getElementById('brainstorm-mode').value;
        const modal = document.getElementById('brainstorm-modal');
        const sourcesDiv = document.getElementById('brainstorm-sources');
        const bodyDiv = document.getElementById('brainstorm-body');
        
        btn.disabled = true;
        const originalText = btn.innerHTML;
        btn.textContent = 'ç”Ÿæˆä¸­...';
        
        try {
            const resp = await fetch('/api/brainstorm', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mode })
            });
            const data = await resp.json();
            
            if (!resp.ok) throw new Error(data.error || 'ç”Ÿæˆå¤±è´¥');
            
            const idea = typeof data.idea === 'string' ? JSON.parse(data.idea) : data.idea;
            
            sourcesDiv.innerHTML = data.source_notes.map((s, i) => `<div>${i+1}. ${s.title}</div>`).join('');
            
            bodyDiv.innerHTML = `
                <div class="mb-4"><strong>è¿æ¥ç‚¹ï¼š</strong>${idea.connection || 'æ— '}</div>
                <div class="mb-4"><strong>æ ‡é¢˜ï¼š</strong>${idea.title || 'æ— '}</div>
                <div><strong>å¤§çº²ï¼š</strong>
                    <ul class="list-disc pl-5 mt-2 space-y-1">
                        ${(idea.outline || []).map(o => `<li>${o}</li>`).join('')}
                    </ul>
                </div>
            `;
            
            modal.classList.remove('hidden');
        } catch (e) {
            alert(e.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }
</script>
{% endblock %}
