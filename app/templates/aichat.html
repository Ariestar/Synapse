<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatBox - AIèŠå¤©å®¤</title>
    <link rel="stylesheet" type="text/css" href="../static/css/styles.css">
    <link rel="stylesheet" type="text/css" href="../static/css/markdown.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css"/>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" id="mathjax-script" defer></script>
</head>
<body 
    x-data="chatApp()"
    x-init="init()"
>
    <!-- ä¾§è¾¹æ  -->
    <div 
        class="sidebar"
        :class="{ 'active': sidebarOpen }"
    >
        <div class="sidebar-header">
            <div class="sidebar-title">å¯¼èˆª</div>
            <button class="close-sidebar" @click="sidebarOpen = false">â˜°</button>
        </div>
        <div class="sidebar-nav">
            <a href="home.html" class="nav-item">ğŸ  é¦–é¡µ</a>
            <a href="aichat.html" class="nav-item active">ğŸ’¬ ChatBox</a>
            <a href="notes.html" class="nav-item">ğŸ“ ç¬”è®°æœ¬</a>
        </div>
        <div class="sidebar-section">
            <div class="sidebar-section-title">API è®¾ç½®</div>
            <div class="sidebar-nav">
                <button class="nav-item" @click="settingsOpen = true">âš™ï¸ APIé…ç½®</button>
            </div>
        </div>
        <div class="sidebar-section">
            <div class="sidebar-section-title">æœç´¢ç¬”è®°</div>
            <div class="sidebar-nav">
                <button class="nav-item" @click="$dispatch('open-rag-search')">ğŸ” æœç´¢ç¬”è®°</button>
            </div>
        </div>
        <div class="sidebar-footer">
            <button class="new-chat-btn" @click="createNewChat()">å¼€å§‹æ–°å¯¹è¯</button>
        </div>
    </div>

    <!-- è®¾ç½®å¼¹çª— -->
    <div 
        class="settings-modal"
        :class="{ 'active': settingsOpen }"
        @click.self="settingsOpen = false"
        @keydown.escape.window="settingsOpen = false"
        x-show="settingsOpen"
        x-cloak
    >
        <div class="settings-content bg-primary rounded-xl shadow-xl">
            <div class="settings-header flex justify-between items-center p-xl border-b">
                <h3 class="settings-title text-xl font-semibold text-primary">API è®¾ç½®</h3>
                <button class="close-settings text-2xl text-muted" @click="settingsOpen = false">&times;</button>
            </div>
            <form class="settings-form p-xl" @submit.prevent="saveSettings()">
                <div class="form-group mb-lg">
                    <label for="provider-select" class="form-label block mb-sm text-sm font-medium text-primary">AI æä¾›å•†</label>
                    <select 
                        id="provider-select" 
                        class="form-input w-full p-md border rounded-md"
                        x-model="settings.provider"
                        @change="loadModels($event.target.value)"
                    >
                        <option value="bigmodel">æ™ºè°±AI (é»˜è®¤)</option>
                        <option value="deepseek">DeepSeek</option>
                        <option value="openai">OpenAI</option>
                        <option value="qwen">é€šä¹‰åƒé—®</option>
                    </select>
                </div>
                <div class="form-group mb-lg">
                    <label for="api-url" class="form-label block mb-sm text-sm font-medium text-primary">API åœ°å€</label>
                    <input 
                        type="text" 
                        id="api-url" 
                        class="form-input w-full p-md border rounded-md"
                        x-model="settings.apiUrl"
                        placeholder="https://api.example.com/v1"
                    >
                </div>
                <div class="form-group mb-lg">
                    <label for="api-key" class="form-label block mb-sm text-sm font-medium text-primary">API å¯†é’¥</label>
                    <input 
                        type="password" 
                        id="api-key" 
                        class="form-input w-full p-md border rounded-md"
                        x-model="settings.apiKey"
                        placeholder="è¾“å…¥æ‚¨çš„APIå¯†é’¥"
                    >
                </div>
                <div class="form-group mb-lg">
                    <label for="model-name" class="form-label block mb-sm text-sm font-medium text-primary">æ¨¡å‹åç§°</label>
                    <select 
                        id="model-name" 
                        class="form-input w-full p-md border rounded-md"
                        x-model="settings.modelName"
                    >
                        <option value="">è¯·é€‰æ‹©æ¨¡å‹</option>
                        <template x-for="model in models" :key="model.id">
                            <option :value="model.id" x-text="model.name"></option>
                        </template>
                    </select>
                </div>
                <div class="form-group mb-lg">
                    <label for="persona" class="form-label block mb-sm text-sm font-medium text-primary">AI è§’è‰²è®¾å®š</label>
                    <textarea 
                        id="persona" 
                        class="form-input w-full p-md border rounded-md"
                        x-model="settings.persona"
                        placeholder="ä¾‹å¦‚ï¼šä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å¿ƒç†å’¨è¯¢å¸ˆ..."
                        rows="3"
                    ></textarea>
                </div>
                <div class="form-group mb-lg">
                    <label class="flex items-center gap-sm">
                        <input type="checkbox" x-model="settings.searchNotes">
                        <span class="text-sm text-primary">å¯ç”¨ç¬”è®°æœç´¢åŠŸèƒ½</span>
                    </label>
                </div>

                <div class="form-group mb-lg">
                    <label class="flex items-center gap-sm">
                        <span class="text-sm text-primary">åŠ©æ‰‹åç§°</span>
                    </label>
                    <input 
                        type="text" 
                        id="assistant-name" 
                        class="form-input w-full p-md border rounded-md" 
                        placeholder="ä¾‹å¦‚ï¼šå°åŠ©æ‰‹"
                    >
                </div>
                <div class="form-group mb-lg">
                    <label class="flex items-center gap-sm">
                        <span class="text-sm text-primary">åŠ©æ‰‹æ€§æ ¼/æç¤ºè¯</span>
                    </label>
                    <textarea 
                        id="assistant-persona" 
                        class="form-input w-full p-md border rounded-md" 
                        rows="3" 
                        placeholder="ä¾‹å¦‚ï¼šæ¸©æŸ”ç®€æ´çš„äº§å“è¿è¥ä¼™ä¼´"
                    ></textarea>
                    <div class="flex gap-sm mt-sm">
                        <button 
                            type="button"
                            class="btn btn-primary px-md py-sm rounded-md"
                            id="assistant-save-btn"
                        >ä¿å­˜åŠ©æ‰‹</button>
                        <button 
                            type="button"
                            class="btn btn-secondary px-md py-sm rounded-md"
                            id="assistant-reload-btn"
                        >é‡æ–°åŠ è½½</button>
                    </div>
                </div>
            </form>
            <div class="settings-footer flex justify-end gap-md p-xl border-t">
                <button 
                    type="button" 
                    class="btn btn-secondary px-lg py-md rounded-md"
                    @click="clearSettings()"
                >æ¸…é™¤</button>
                <button 
                    type="button" 
                    class="btn btn-primary px-lg py-md rounded-md"
                    @click="saveSettings()"
                >ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- ç¬”è®°æœç´¢å¼¹çª— - å¤ç”¨ notes.html çš„ç»„ä»¶ -->
    <div 
        x-data="ragSearch()" 
        x-show="isOpen" 
        @keydown.escape.window="close()"
        @open-rag-search.window="open()"
        class="notes-search-modal"
        :class="{ 'active': isOpen }"
        style="display: none;"
        x-cloak
    >
        <div class="notes-search-content" @click.away="close()">
            <div class="notes-search-header">
                <h3 class="notes-search-title">æœç´¢ç¬”è®°</h3>
                <button class="close-notes-search" @click="close()">&times;</button>
            </div>
            <div class="notes-search-body">
                <div class="search-box">
                    <input 
                        type="text" 
                        x-model="query"
                        @keydown.enter="search()"
                        placeholder="è¾“å…¥é—®é¢˜æˆ–å…³é”®è¯..."
                        class="flex-1"
                    >
                    <button @click="search()" :disabled="loading">æœç´¢</button>
                </div>
                
                <div class="rag-answer-container" x-show="answer">
                    <h4 class="text-sm font-semibold mb-md text-primary">AI å›ç­”</h4>
                    <div class="rag-answer bg-muted p-lg rounded-lg" x-html="safeHtml(answer)"></div>
                </div>
                
                <div class="rag-citations-container" x-show="citations.length > 0">
                    <h4 class="text-sm font-semibold mb-md text-primary">å¼•ç”¨æ¥æº</h4>
                    <div class="flex flex-col gap-sm">
                        <template x-for="(citation, idx) in citations" :key="idx">
                            <div class="rag-citation-item bg-muted p-md rounded-lg">
                                <div class="font-semibold text-primary mb-xs" x-text="`[${idx + 1}] ${citation.title || 'æ— æ ‡é¢˜'}`"></div>
                                <div class="text-sm text-secondary mb-xs" x-text="`${citation.rel_path || citation.file_path || 'æœªçŸ¥è·¯å¾„'} Â· ç›¸ä¼¼åº¦: ${citation.score !== undefined ? citation.score.toFixed(4) : 'N/A'}`"></div>
                                <div class="text-sm text-secondary" x-text="citation.snippet || ''"></div>
                            </div>
                        </template>
                    </div>
                </div>
                
                <div class="notes-search-results" x-show="results.length > 0">
                    <template x-for="(note, idx) in results" :key="idx">
                        <div class="note-search-card" @click="close()">
                            <div class="note-search-card-header">
                                <div class="note-search-card-title" x-text="note.title || 'æ— æ ‡é¢˜'"></div>
                                <span class="note-search-card-score" x-text="`ç›¸ä¼¼åº¦ ${note.score !== undefined ? note.score.toFixed(4) : (note.similarity ? note.similarity.toFixed(4) : 'N/A')}`"></span>
                            </div>
                            <div class="note-search-card-path" x-text="note.rel_path || note.file_path || 'æœªçŸ¥è·¯å¾„'"></div>
                            <div class="note-search-card-body" x-text="(note.content || '').slice(0, 240)"></div>
                            <div class="note-search-card-tags">
                                <template x-for="tag in (Array.isArray(note.tags) && note.tags.length ? note.tags : ['æ— æ ‡ç­¾'])" :key="tag">
                                    <span class="note-search-card-tag" x-text="tag"></span>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>
                
                <div x-show="loading" class="text-center py-xl text-secondary">æ£€ç´¢ä¸­...</div>
                <div x-show="!loading && !query && results.length === 0" class="text-center py-xl text-muted">è¯·è¾“å…¥å…³é”®è¯æœç´¢ç¬”è®°</div>
            </div>
        </div>
    </div>

    <div 
        class="sidebar-overlay"
        :class="{ 'active': sidebarOpen }"
        @click="sidebarOpen = false"
    ></div>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div 
        class="main-content"
        :class="{ 'sidebar-open': sidebarOpen }"
    >
        <header class="header-container">
            <div class="top-navbar">
                <div class="navbar-left flex items-center gap-md">
                    <button class="menu-btn" @click="sidebarOpen = !sidebarOpen" title="èœå•">
                        <img src="../static/img/menu.svg" alt="èœå•" width="24" height="24">
                    </button>
                    <div class="title">ChatBox - AIèŠå¤©å®¤</div>
                </div>
            </div>
        </header>

        <main class="chat-main">
            <div class="chat-container">
                <div class="chat-messages-wrapper">
                    <div class="chat-messages" id="chat-messages">
                        <div class="message-container bot">
                            <div class="avatar bot-avatar">AI</div>
                            <div class="message-content">
                                <div class="message bot-message">
                                    ä½ å¥½ï¼ä»Šå¤©æ„Ÿè§‰å¦‚ä½•å‘€ï¼Ÿæˆ‘æ°¸è¿œæ˜¯ä½ å¿ å®çš„å€¾å¬è€…ã€‚æ— è®ºæ˜¯æƒ³åˆ†äº«ä¸€ç¼•é˜³å…‰ï¼Œè¿˜æ˜¯å€’ä¸€å€’å¿ƒé‡Œçš„é›¨ï¼Œæˆ‘éƒ½åœ¨è¿™é‡Œã€‚ä½ çš„å¿«ä¹ã€çƒ¦æ¼æˆ–ä»»ä½•å°æ€ç»ªï¼Œæˆ‘éƒ½æ„¿æ„å®‰é™åœ°å¬ä½ è¯´ã€‚
                                </div>
                                <div class="message-time">åˆšåˆš</div>
                            </div>
                        </div>
                    </div>
                    <div class="typing-indicator" id="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>

                <div class="input-area-wrapper">
                    <!-- å·¥å…·æ ï¼šæ£€ç´¢å¼€å…³ -->
                    <div class="input-toolbar">
                        <button 
                            class="toolbar-btn"
                            :class="{ 'active': settings.searchNotes }"
                            @click="toggleSearchNotes()"
                            title="ç¬”è®°æ£€ç´¢"
                        >
                            <svg class="toolbar-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="m21 21-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span class="toolbar-text">ç¬”è®°æ£€ç´¢</span>
                        </button>
                    </div>
                    
                    <div class="input-area">
                        <textarea 
                            class="message-input" 
                            id="message-input" 
                            placeholder="å‘ AI å‘é€æ¶ˆæ¯..." 
                            rows="1"
                            @keydown.enter.exact.prevent="sendMessage()"
                            @input="autoResize($el)"
                        ></textarea>
                        <button 
                            class="send-button" 
                            id="send-button" 
                            title="å‘é€æ¶ˆæ¯"
                            @click="sendMessage()"
                        >
                            <svg class="send-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                        <button 
                            class="save-note-button" 
                            id="save-note-button" 
                            title="ä¿å­˜æœ€åé—®ç­”ä¸ºç¬”è®° (Ctrl+S)"
                            @click="saveConversationAsNote()"
                        >
                            <svg class="save-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <polyline points="17 21 17 13 7 13 7 21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <polyline points="7 3 7 8 15 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Alpine.js ç»„ä»¶
        function chatApp() {
            return {
                sidebarOpen: false,
                settingsOpen: false,
                settings: {
                    provider: 'bigmodel',
                    apiUrl: '',
                    apiKey: '',
                    modelName: '',
                    persona: '',
                    searchNotes: true  // é»˜è®¤å¼€å¯æ£€ç´¢åŠŸèƒ½
                },
                models: [],
                
                init() {
                    this.loadSettings();
                    this.loadModels(this.settings.provider);
                },
                
                loadSettings() {
                    const saved = JSON.parse(localStorage.getItem('llmSettings')) || {};
                    // å¦‚æœä¹‹å‰æ²¡æœ‰ä¿å­˜è¿‡ searchNotesï¼Œé»˜è®¤å¼€å¯
                    if (saved.searchNotes === undefined) {
                        saved.searchNotes = true;
                    }
                    this.settings = { ...this.settings, ...saved };
                },
                
                toggleSearchNotes() {
                    this.settings.searchNotes = !this.settings.searchNotes;
                    localStorage.setItem('llmSettings', JSON.stringify(this.settings));
                    this.showNotification(
                        this.settings.searchNotes ? 'ç¬”è®°æ£€ç´¢å·²å¼€å¯' : 'ç¬”è®°æ£€ç´¢å·²å…³é—­',
                        'info'
                    );
                },
                
                async loadModels(provider) {
                    if (!provider) provider = 'bigmodel';
                    try {
                        const response = await fetch(`/list_models?provider=${provider}`);
                        if (response.ok) {
                            this.models = await response.json();
                        }
                    } catch (error) {
                        console.error('åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥:', error);
                        this.models = [];
                    }
                },
                
                saveSettings() {
                    localStorage.setItem('llmSettings', JSON.stringify(this.settings));
                    this.settingsOpen = false;
                    this.showNotification('è®¾ç½®å·²ä¿å­˜', 'success');
                },
                
                clearSettings() {
                    localStorage.removeItem('llmSettings');
                    this.settings = {
                        provider: 'bigmodel',
                        apiUrl: '',
                        apiKey: '',
                        modelName: '',
                        persona: '',
                        searchNotes: true  // é»˜è®¤å¼€å¯æ£€ç´¢åŠŸèƒ½
                    };
                    this.showNotification('è®¾ç½®å·²æ¸…é™¤', 'info');
                },
                
                createNewChat() {
                    if (window.createNewConversation) {
                        window.createNewConversation();
                    }
                    this.sidebarOpen = false;
                },
                
                sendMessage() {
                    if (window.sendMessage) {
                        window.sendMessage();
                    }
                },
                
                saveConversationAsNote() {
                    if (window.saveConversationAsNote) {
                        window.saveConversationAsNote();
                    }
                },
                
                autoResize(textarea) {
                    textarea.style.height = 'auto';
                    textarea.style.height = textarea.scrollHeight + 'px';
                },
                
                showNotification(message, type = 'info') {
                    const notification = document.createElement('div');
                    notification.className = `notification notification-${type}`;
                    notification.textContent = message;
                    notification.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        padding: 15px 20px;
                        border-radius: 5px;
                        color: white;
                        font-weight: bold;
                        z-index: 10000;
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                        transform: translateX(100%);
                        transition: transform 0.3s ease-in-out;
                    `;
                    
                    const colors = {
                        success: '#4CAF50',
                        error: '#f44336',
                        warning: '#ff9800',
                        info: '#2196F3'
                    };
                    notification.style.backgroundColor = colors[type] || colors.info;
                    
                    document.body.appendChild(notification);
                    setTimeout(() => notification.style.transform = 'translateX(0)', 10);
                    setTimeout(() => {
                        notification.style.transform = 'translateX(100%)';
                        setTimeout(() => notification.remove(), 300);
                    }, 3000);
                }
            };
        }
        
        // RAG æœç´¢ç»„ä»¶ï¼ˆå¤ç”¨ notes.html çš„ï¼‰
        function ragSearch() {
            return {
                isOpen: false,
                query: '',
                loading: false,
                answer: '',
                citations: [],
                results: [],
                
                open() {
                    this.isOpen = true;
                    this.query = '';
                    this.answer = '';
                    this.citations = [];
                    this.results = [];
                    this.$nextTick(() => {
                        const input = this.$el.querySelector('input[type="text"]');
                        if (input) input.focus();
                    });
                },
                
                close() {
                    this.isOpen = false;
                },
                
                safeHtml(text) {
                    if (!text) return '';
                    if (typeof DOMPurify !== 'undefined') {
                        return DOMPurify.sanitize(text);
                    }
                    return text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                },
                
                async search() {
                    const query = this.query.trim();
                    if (!query) {
                        this.answer = '';
                        this.citations = [];
                        this.results = [];
                        return;
                    }
                    
                    this.loading = true;
                    this.answer = '';
                    this.citations = [];
                    this.results = [];
                    
                    try {
                        const settings = JSON.parse(localStorage.getItem('llmSettings')) || {};
                        const response = await fetch('/api/rag/query', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                question: query,
                                top_k: 12,
                                provider: settings.provider || 'bigmodel',
                                model: settings.modelName || undefined,
                                base_url: settings.apiUrl || undefined,
                                api_key: settings.apiKey || undefined,
                                persona: settings.persona || undefined,
                            })
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            this.answer = result.answer || '';
                            this.citations = result.citations || [];
                            this.results = result.contexts || [];
                        } else {
                            const errText = await response.text();
                            this.answer = `æœç´¢å¤±è´¥ï¼š${errText}`;
                            this.citations = [];
                            this.results = [];
                        }
                    } catch (error) {
                        this.answer = 'æœç´¢å‡ºé”™ï¼Œè¯·ç¨åé‡è¯•';
                        this.citations = [];
                        this.results = [];
                    } finally {
                        this.loading = false;
                    }
                }
            };
        }
    </script>
    
    <style>
        [x-cloak] { display: none !important; }
        .rag-answer-container, .rag-citations-container {
            margin-bottom: var(--spacing-lg);
        }
    </style>
    
    <script src="../static/js/scripts.js"></script>
</body>
</html>
