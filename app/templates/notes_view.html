{% extends "base.html" %}

{% block title %}View Note - KingStudy{% endblock %}
{% block page_title %}Note{% endblock %}

{% block content %}
<div 
    x-data="noteViewer()"
    x-init="init()"
    class="max-w-4xl mx-auto py-8 px-4 sm:px-6 lg:px-8"
>
    <!-- Toolbar -->
    <div class="flex justify-between items-center mb-6">
        <button onclick="history.back()" class="text-gray-500 hover:text-black flex items-center text-sm font-medium">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            返回
        </button>
        
        <div class="flex gap-2">
            <template x-if="!isEditing">
                <div class="flex gap-2">
                    <button 
                        @click="copyMarkdown()"
                        class="inline-flex items-center px-3 py-1.5 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none"
                    >
                        复制 Markdown
                    </button>
                    <button 
                        @click="enterEditMode()"
                        class="inline-flex items-center px-3 py-1.5 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-black hover:bg-gray-800 focus:outline-none"
                    >
                        编辑
                    </button>
                </div>
            </template>
            <template x-if="isEditing">
                <div class="flex gap-2">
                    <button 
                        @click="exitEditMode()"
                        class="inline-flex items-center px-3 py-1.5 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none"
                    >
                        取消
                    </button>
                    <button 
                        @click="saveNote()"
                        class="inline-flex items-center px-3 py-1.5 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-black hover:bg-gray-800 focus:outline-none"
                    >
                        保存
                    </button>
                </div>
            </template>
        </div>
    </div>

    <!-- Content Card -->
    <div class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden min-h-[500px]">
        
        <!-- Header -->
        <div class="px-8 py-6 border-b border-gray-100 bg-gray-50/50">
            <h1 class="text-3xl font-bold text-gray-900 mb-2" x-text="title || '加载中...'"></h1>
            <div class="flex flex-wrap items-center gap-2 text-sm text-gray-500">
                <span x-text="currentPath || ''" class="font-mono text-xs"></span>
                <template x-for="tag in tags" :key="tag">
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-200 text-gray-800" x-text="tag"></span>
                </template>
            </div>
        </div>

        <!-- View Mode -->
        <div 
            x-show="!isEditing"
            id="note-body" 
            class="markdown-body p-8"
        ></div>

        <!-- Edit Mode -->
        <div 
            x-show="isEditing"
            class="flex flex-col md:flex-row h-[calc(100vh-300px)] min-h-[500px]"
            style="display: none;"
        >
            <!-- Editor -->
            <div class="flex-1 flex flex-col border-b md:border-b-0 md:border-r border-gray-200">
                <div class="px-4 py-2 bg-gray-100 text-xs font-medium text-gray-500 uppercase tracking-wider">Markdown 编辑</div>
                <textarea 
                    x-model="editorContent"
                    @input="debounceUpdatePreview()"
                    class="flex-1 w-full p-4 resize-none font-mono text-sm bg-gray-50 focus:outline-none focus:bg-white transition-colors"
                    placeholder="# 输入 Markdown 内容..."
                ></textarea>
            </div>
            
            <!-- Preview -->
            <div class="flex-1 flex flex-col bg-white">
                <div class="px-4 py-2 bg-gray-100 text-xs font-medium text-gray-500 uppercase tracking-wider border-l border-gray-200">实时预览</div>
                <div 
                    id="note-preview" 
                    class="flex-1 p-4 overflow-y-auto markdown-body"
                ></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="../static/js/mathjax_helper.js"></script>
<script>
    function noteViewer() {
        return {
            currentPath: null,
            title: '',
            tags: [],
            editorContent: '',
            isEditing: false,
            originalContent: '',
            
            init() {
                const params = new URLSearchParams(window.location.search);
                const path = params.get('path');
                if (path) {
                    this.loadNote(path);
                } else {
                    this.title = '未指定笔记路径';
                }
            },
            
            async loadNote(path) {
                this.currentPath = path;
                try {
                    const resp = await fetch(`/api/md/file?path=${encodeURIComponent(path)}`);
                    if (!resp.ok) throw new Error('Note not found');
                    const data = await resp.json();
                    
                    this.title = data.frontmatter?.title || path.split('/').pop();
                    this.tags = this.normalizeTags(data.frontmatter?.tags);
                    this.originalContent = data.content || '';
                    this.editorContent = this.originalContent;
                    
                    // Render View
                    this.render(this.originalContent, 'note-body');
                } catch (e) {
                    console.error(e);
                    document.getElementById('note-body').innerHTML = '<div class="text-red-500">无法加载笔记内容</div>';
                }
            },
            
            normalizeTags(tags) {
                if (!tags) return [];
                if (Array.isArray(tags)) return tags;
                if (typeof tags === 'string') return tags.split(/[,，\s]+/).filter(Boolean);
                return [];
            },
            
            enterEditMode() {
                this.isEditing = true;
                this.$nextTick(() => {
                    this.render(this.editorContent, 'note-preview');
                });
            },
            
            exitEditMode() {
                this.isEditing = false;
                this.editorContent = this.originalContent;
            },
            
            async saveNote() {
                if (!this.currentPath) return;
                try {
                    const resp = await fetch('/api/md/file', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            path: this.currentPath, 
                            content: this.editorContent 
                        })
                    });
                    if (!resp.ok) throw new Error(await resp.text());
                    
                    this.originalContent = this.editorContent;
                    this.isEditing = false;
                    this.render(this.originalContent, 'note-body');
                    alert('已保存');
                } catch (e) {
                    alert(`保存失败: ${e.message}`);
                }
            },
            
            async copyMarkdown() {
                try {
                    await navigator.clipboard.writeText(this.originalContent);
                    alert('已复制');
                } catch (e) {
                    alert('复制失败');
                }
            },
            
            render(content, elementId) {
                const el = document.getElementById(elementId);
                if (!el) return;
                
                if (typeof marked !== 'undefined') {
                    let html = marked.parse(content);
                    if (typeof DOMPurify !== 'undefined') {
                        html = DOMPurify.sanitize(html);
                    }
                    el.innerHTML = html;
                    // Highlight
                    el.querySelectorAll('pre code').forEach(block => {
                        hljs.highlightElement(block);
                    });
                    // MathJax
                    if (window.MathJax && window.MathJax.typesetPromise) {
                        window.MathJax.typesetPromise([el]).catch(console.error);
                    }
                } else {
                    el.innerText = content;
                }
            },
            
            debounceUpdatePreview: function() {
                // Simple debounce implementation using Alpine's internal or manual
                // Alpine x-model.debounce is easier but here we call render
                if (this._debounceTimer) clearTimeout(this._debounceTimer);
                this._debounceTimer = setTimeout(() => {
                    this.render(this.editorContent, 'note-preview');
                }, 300);
            }
        };
    }
</script>
{% endblock %}
